---
- name: lookup user info
  user:
    name: "{{ user_name }}"
  register: user
  tags:
    - always

- name: install dotfiles
  copy:
    src: home/
    dest: "{{ user.home }}/"
    owner: '{{ user.name }}'
    group: '{{ user.group }}'
    force: yes
    local_follow: no
  tags:
    - dotfiles

- name: install binaries
  file:
    path: "{{ user.home }}/bin/"
    mode: +x
    recurse: yes
  tags:
    - dotfiles

- name: secure gpg directory
  file:
    path: "{{ user.home }}/.gnupg"
    mode: og-rwx
    recurse: yes
  tags:
    - dotfiles

- name: mark virtual machine directories as nocow
  ignore_errors: yes
  file:
    owner: "{{ user.name }}"
    group: "{{ user.group }}"
    path: "{{ user.home }}/{{ item }}"
    attributes: +C
    state: directory
  loop:
    - VirtualBox VMs
    - .local/share/libvirt/images

- name: install packages for the user
  ignore_errors: yes
  package:
    state: present
    name:
      - thefuck
      - udiskie
      - lesspipe
      - moreutils
      - unzip
      - unrar
      - get
      - emacs
      - mu
      - offlineimap
      - lastpass-cli
      - trash-cli
      - fzf
      - fd
      - ripgrep
      - bat
      - rustup

- name: perform installation and update tasks as user
  become: yes
  become_user: "{{ user.name }}"
  ignore_errors: yes
  module_defaults:
    npm:
      state: latest
      global: yes
    command:
      chdir: "{{ user.home }}"
  block:
    - command: emacs --batch -l .emacs.d/init.el -f auto-package-update-now
    - command: rustup update stable
    - command: rustup self update
