---
- name: install packages for the user
  ignore_errors: yes
  package:
    state: present
    name:
      - thefuck
      - udiskie
      - lesspipe
      - moreutils
      - unzip
      - unrar
      - wget
      - emacs
      - mu
      - offlineimap

- name: lookup user info
  user:
    name: "{{ user_name }}"
  register: user
  tags:
    - always

- name: install dotfiles
  block:
    - name: copy just portable files
      copy:
        src: home/{{ item }}
      loop:
        - .profile
        - .inputrc
        - .bashrc
        - .bash_profile
        - .aliases
        - .screenrc
        - .config/git/config
        - .config/git/ignore
        - .ssh/config
        - .emacs
        - .emacs_bash

      tags:
        - basic

    - name: copy full dotfiles
      copy:
        src: home/
      tags:
        - full

  module_defaults:
    copy:
      dest: "{{ user.home }}/"
      owner: '{{ user.name }}'
      group: '{{ user.group }}'
      force: yes
      local_follow: no
  tags:
    - dotfiles

- name: secure gpg directory
  file:
    path: "{{ user.home }}/.gnupg"
    mode: og-rwx
    recurse: yes
  tags: gpg

- name: mark virtual machine directories as nocow
  file:
    owner: "{{ user.name }}"
    group: "{{ user.group }}"
    path: "{{ user.home }}/{{ item }}"
    attributes: +C
    state: directory
  loop:
    - VirtualBox VMs
    - .local/share/libvirt/images

- name: compile and update .emacs
  command: emacs --batch -f install-and-update-packages
  become: yes
  become_user: "{{ user.name }}"
